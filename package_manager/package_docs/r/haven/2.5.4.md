# R haven Package v2.5.4 -- Approved Documentation

**Package:** haven
**Version:** 2.5.4 (approved)
**Language:** R
**CRAN:** https://cran.r-project.org/package=haven
**Validation Status:** Approved (2025-11-15)

---

## Overview

The `haven` package reads and writes SAS, SPSS, and Stata data files from R. For SDTM programming, its primary use is writing XPT (SAS XPORT v5) transport files required for FDA regulatory submissions.

## Installation (Enterprise)

```r
install.packages('haven', repos='https://internal-cran.company.com')
packageVersion('haven')
# Expected: '2.5.4'
```

## Key Functions

### `write_xpt(data, path, version = 5, ...)`
Write a data frame as a SAS XPORT v5 transport file for FDA submission.

```r
# Standard FDA submission format
haven::write_xpt(dm, path = "orchestrator/outputs/validation/dm.xpt", version = 5)
```

**Parameters:**
- `data` (data.frame): Data to write
- `path` (character): Output file path (should end in .xpt)
- `version` (integer, default 5): XPORT format version. **MUST be 5 for FDA.**
- `name` (character, optional): Dataset name (default: derived from data name)

**RESTRICTIONS:**
- ALWAYS use `version = 5` for FDA submissions. Do NOT use `version = 8`.
- Variable names must be <= 8 characters for XPORT v5.
- Labels must be <= 40 characters (silently truncated if longer).
- Set labels BEFORE writing: `attr(df$SEX, 'label') <- 'Sex'`

### `read_sas(data_file, ...)`
Read a SAS7BDAT file into R.

```r
# Read SAS dataset
dm <- haven::read_sas("study_data/raw_dm.sas7bdat")

# Read with encoding
dm <- haven::read_sas("raw_dm.sas7bdat", encoding = "latin1")
```

**Parameters:**
- `data_file` (character): Path to .sas7bdat file
- `catalog_file` (character, optional): Path to .sas7bcat catalog
- `encoding` (character, optional): Character encoding
- `col_select` (character vector, optional): Columns to read

### `read_xpt(file, ...)`
Read a SAS XPORT transport file.

```r
# Read XPT for validation comparison
dm_xpt <- haven::read_xpt("orchestrator/outputs/validation/dm.xpt")
```

### `write_sas(data, path, ...)`
Write a SAS7BDAT file from R.

```r
haven::write_sas(dm, "output/dm.sas7bdat")
```

## Setting Variable Labels for XPT

Labels must be assigned as attributes before writing XPT:

```r
# Set individual labels
attr(dm$STUDYID, 'label') <- 'Study Identifier'
attr(dm$USUBJID, 'label') <- 'Unique Subject Identifier'
attr(dm$SEX, 'label') <- 'Sex'
attr(dm$AGE, 'label') <- 'Age'
attr(dm$AGEU, 'label') <- 'Age Units'
attr(dm$RACE, 'label') <- 'Race'

# Or set all at once using a named vector
labels <- c(STUDYID = "Study Identifier", USUBJID = "Unique Subject Identifier",
            SEX = "Sex", AGE = "Age", AGEU = "Age Units", RACE = "Race")
for (var in names(labels)) {
  attr(dm[[var]], 'label') <- labels[var]
}

# Write with labels
haven::write_xpt(dm, path = "dm.xpt", version = 5)
```

## Version-Specific Notes (2.5.4)

- write_xpt() silently truncates labels > 40 characters in v5 format
- Numeric precision may differ slightly between SAS and R for XPORT roundtripping
- Date variables should be stored as character (ISO 8601) in SDTM, not as Date class
